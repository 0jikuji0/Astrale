<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Astéroïde avec Terre et trajectoire</title>
<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; }
  canvas { display:block; }
  #ui {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
    background: rgba(0,0,0,0.4);
    padding: 8px;
    border-radius: 8px;
    color:white;
  }
  label { display:block; margin:6px 0 2px; font-size:14px; }
  input { width:120px; }
  button { margin-top:8px; padding:6px 12px; font-size:14px; }
  .label {
    font-size: 14px;
    color: white;
    background: rgba(0,0,0,0.6);
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
  }
</style>
</head>
<body>
<div id="ui">
  <label for="sizeRange">Taille astéroïde</label>
  <input type="range" id="sizeRange" min="0.2" max="2" step="0.1" value="0.5">
  <label for="speedRange">Vitesse</label>
  <input type="range" id="speedRange" min="0.0005" max="0.01" step="0.0005" value="0.002">
  <br>
  <button id="rewindBtn">Rejouer</button>
</div>
<canvas id="canvas"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS2DRenderer.js"></script>

<script>
let scene, camera, renderer, asteroid, earth;
let t = 0;
let vitesse = 0.002;
let asteroidScale = 0.5;

// --- Scene & Renderer ---
scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);
camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 20000);
camera.position.set(0, 5, 10);
renderer = new THREE.WebGLRenderer({canvas: document.getElementById('canvas'), antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);

// --- Label Renderer ---
const labelRenderer = new THREE.CSS2DRenderer();
labelRenderer.setSize(window.innerWidth, window.innerHeight);
labelRenderer.domElement.style.position = 'absolute';
labelRenderer.domElement.style.top = '0px';
document.body.appendChild(labelRenderer.domElement);

// --- Lumières ---
scene.add(new THREE.AmbientLight(0xffffff, 0.4));
const light = new THREE.PointLight(0xffffff, 2, 5000);
light.position.set(20,20,20);
scene.add(light);

// --- Terre ---
const earthGeo = new THREE.SphereGeometry(20, 128, 128);
const earthTex = new THREE.TextureLoader().load(
  'https://unpkg.com/three-globe@2.24.4/example/img/earth-blue-marble.jpg'
);
const earthMat = new THREE.MeshPhongMaterial({ map: earthTex, shininess: 10 });
earth = new THREE.Mesh(earthGeo, earthMat);
earth.position.set(0, -2, -10);
scene.add(earth);

// Rotation aléatoire initiale et vitesse de rotation
earth.rotation.x = Math.random() * Math.PI * 2;
earth.rotation.y = Math.random() * Math.PI * 2;
earth.rotation.z = Math.random() * Math.PI * 2;
earth.r = {
  x: (Math.random() * 0.001) + 0.0002,
  y: (Math.random() * 0.001) + 0.0002,
  z: (Math.random() * 0.001) + 0.0002
};

// --- Astéroïde ---
const geom = new THREE.SphereGeometry(1, 128, 64);
const loader = new THREE.TextureLoader();
const meteorMaterial = new THREE.MeshStandardMaterial({
    map: loader.load('textures/Rock030_1K-JPG_Color.jpg'),
    roughnessMap: loader.load('textures/Rock030_1K-JPG_Roughness.jpg'),
    roughness: 0.8,
    metalness: 0.1,
    normalMap: loader.load('textures/Rock030_1K-JPG_NormalGL.jpg'),
    displacementMap: loader.load('textures/Rock030_1K-JPG_Displacement.jpg'),
    displacementScale: 0.3,   
    aoMap: loader.load('textures/Rock030_1K-JPG_AmbientOcclusion.jpg'),
    flatShading: false
});
asteroid = new THREE.Mesh(geom, meteorMaterial);
asteroid.scale.set(asteroidScale, asteroidScale, asteroidScale);
asteroid.r = {x:0.002, y:0.004, z:0.003};
scene.add(asteroid);

const earthRadius = earthGeo.parameters.radius;
let asteroidRadius = asteroidScale;

// --- Label texte de l'astéroïde ---
const asteroidDiv = document.createElement('div');
asteroidDiv.className = 'label';
asteroidDiv.textContent = "Astéroïde";
const asteroidLabel = new THREE.CSS2DObject(asteroidDiv);
asteroid.add(asteroidLabel);
asteroidLabel.position.set(0, 3, 0);

// --- Trajectoire ---
const startPos = new THREE.Vector3(200,50,600);
const endPos = earth.position.clone();
const steps = 100;
const trajectoryPoints = [];
for(let i = 0; i <= steps; i++){
  trajectoryPoints.push(new THREE.Vector3().lerpVectors(startPos, endPos, i/steps));
}
const trajectoryGeom = new THREE.BufferGeometry().setFromPoints(trajectoryPoints);
const trajectoryMat = new THREE.LineBasicMaterial({ color: 0xff0000 });
const trajectoryLine = new THREE.Line(trajectoryGeom, trajectoryMat);
scene.add(trajectoryLine);

// --- Etoiles ---
const starsGeom = new THREE.BufferGeometry();
const starsVerts = [];
const starDistance = 8000;
for(let i=0;i<20000;i++){
  starsVerts.push(
    (Math.random()-0.5)*starDistance,
    (Math.random()-0.5)*starDistance,
    (Math.random()-0.5)*starDistance
  );
}
starsGeom.setAttribute('position', new THREE.Float32BufferAttribute(starsVerts, 3));
scene.add(new THREE.Points(starsGeom, new THREE.PointsMaterial({color:0xffffff, size:0.5})));

// --- UI sliders ---
document.getElementById('sizeRange').addEventListener('input', e=>{
  asteroidScale = parseFloat(e.target.value);
  asteroid.scale.set(asteroidScale, asteroidScale, asteroidScale);
  asteroidRadius = asteroidScale;
});
document.getElementById('speedRange').addEventListener('input', e=>{
  vitesse = parseFloat(e.target.value);
});
document.getElementById('rewindBtn').addEventListener('click', ()=>{
  t = 0;
  asteroid.position.copy(startPos);
  earth.material.color.set(0xffffff);
});

// --- Animation ---
const cameraOffset = new THREE.Vector3(5,2,10);

asteroid.position.copy(startPos);

function animate(){
  requestAnimationFrame(animate);

  // Calcul de la distance à la Terre
  const toEarth = new THREE.Vector3().subVectors(endPos, asteroid.position);
  const distance = toEarth.length();

  // Si pas encore collision, avancer
  if(distance > earthRadius + asteroidRadius){
    const step = toEarth.clone().normalize().multiplyScalar(vitesse*1000); // ajuster vitesse
    asteroid.position.add(step);
  } else {
    // Collision détectée
    earth.material.color.set(0xff0000); // effet visuel
  }

  // Rotation astéroïde
  asteroid.rotation.x += asteroid.r.x;
  asteroid.rotation.y += asteroid.r.y;
  asteroid.rotation.z += asteroid.r.z;

  // Rotation Terre
  earth.rotation.x += earth.r.x;
  earth.rotation.y += earth.r.y;
  earth.rotation.z += earth.r.z;

  // POV camera
  camera.position.copy(asteroid.position).add(cameraOffset);
  camera.lookAt(asteroid.position);

  renderer.render(scene,camera);
  labelRenderer.render(scene,camera);
}

animate();
</script>

</body>
</html>
